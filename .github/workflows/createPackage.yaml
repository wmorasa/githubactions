name: CreatePackage
 
on:
  workflow_dispatch:
    inputs:
      tagName:
        required: true
        type: string  
  #    version:
  #      required: false
      
  # push:
    # branches: ['main']
      
env:
  ARTIFACTORY_REGISTRY: https://bpd01artifactory.glideportal.transurban.com.au/artifactory
  GITHUB_CONTEXT: ${{toJson(github)}}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  CreatePackage:
    runs-on: ubuntu-latest
    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    permissions:
      contents: write
      packages: write
 
    steps:
      - name: Setup Environment Variables
        run: |
        echo "package_prefix=$( ${{ github.repository }} / cut -f2 -d'/' | tr "[:lower:]" "[:upper:]" | sed 's/-/_/g' )" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          # Fetch all history for all tags and branches
          fetch-depth: 0 
          # Checkout a different branch
          ref: ${{ github.event.inputs.tagName }} 
          # Relative path under $GITHUB_WORKSPACE to place the repository
          path: ${{ env.package_prefix }}-${{ github.event.inputs.tagName }}

      - name: ShowRepo
        run: |      
          #git tag -l
          pwd
          ls -l
          #rm -rf ${{ github.event.inputs.tagName }}/.git 
          #rm -rf ${{ github.event.inputs.tagName }}/.opsjobs 
          find . -print
   
      # - name: PackageCreate
      #   id: PackageCreate
      #   env: 
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     tag: ${{ github.event.inputs.tagName }}
      #   run: |    
      #     PackageName="${GITHUB_REPOSITORY#*/}"
      #     PackageName="${PackageName^^}-${tag}"
      #     echo "branchName is : ${PackageName}"
      #     echo "test: ${PackageName}"
      #     gh release create "${PackageName}" \
      #       --repo="$GITHUB_REPOSITORY" \
      #       --title="${PackageName}" #\
      #     # --generate-notes

      # - name: createPackage
      #   id: createPackage
      #   env: 
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #   run: | 
      #     ls -l
      #     pwd

      # - name: Zip directory
      #   run: |
      #     cd ${{ github.workspace }}
      #     zip -r output.zip .
      
      # - name: Upload zip
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: my-artifact
      #     path: ${{ github.workspace }}/output.zip
